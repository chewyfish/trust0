SHELL:=bash

# Params

RUNKEY=000000
PERFTEST_DIR=$(shell dirname $(realpath $(firstword $(MAKEFILE_LIST))))
PERFTEST_BUILD_DIR=${PERFTEST_DIR}/target/${RUNKEY}
PROJECT_DIR=${PERFTEST_DIR}/../..
PROJECT_RESOURCES_DIR=${PROJECT_DIR}/resources
CONTAINER_APP_DIR=/app
UID=1000
GID=1000

DOCKER_CMD=docker
DOCKER_COMPOSE_CMD=docker-compose

EXECBIN_EXTRA_ARGS=
EXECBIN_EXTRA_CLIENT_ARGS=

# Params - Datasource

DATASOURCE_INMEMDB_DB_CONNECT=${PERFTEST_BUILD_DIR}
DATASOURCE_MYSQLDB_DB_CONNECT=mysql://t0user:t0pass@localhost:3306/trust0
DATASOURCE_POSTGRESDB_DB_CONNECT=postgres://t0user:t0pass@localhost:5432/trust0

# Params - Certificate Authority

ROOT_CA__PKI_NAME=t0perf-root-ca
ROOT_CA__PKI_VALID_NOT_AFTER=2100-01-01T00:00:00Z
ROOT_CA__PKI_SUBJ_COUNTRY=US
ROOT_CA__PKI_SUBJ_STATE=CA
ROOT_CA__PKI_SUBJ_CITY=Nowhere
ROOT_CA__PKI_SUBJ_COMPANY=ExampleCA
ROOT_CA__PKI_SUBJ_DEPT=IT
ROOT_CA__PKI_SUBJ_COMMONNAME=${ROOT_CA__PKI_NAME}
ROOT_CA__PKI_CERT_FILE=${PERFTEST_BUILD_DIR}/${ROOT_CA__PKI_NAME}.crt.pem
ROOT_CA__PKI_CERT_CONTAINER_FILE=${CONTAINER_APP_DIR}/config/${ROOT_CA__PKI_NAME}.crt.pem
ROOT_CA__PKI_KEY_FILE=${PERFTEST_BUILD_DIR}/${ROOT_CA__PKI_NAME}.key.pem
ROOT_CA__PKI_KEY_CONTAINER_FILE=${CONTAINER_APP_DIR}/config/${ROOT_CA__PKI_NAME}.key.pem

# Params - Trust Gateway

TRUST0_GATEWAY__PKI_NAME=t0perf-t0gateway1
TRUST0_GATEWAY__PKI_VALID_NOT_AFTER=2100-01-01T00:00:00Z
TRUST0_GATEWAY__PKI_SERIAL_NUM=03e7
TRUST0_GATEWAY__PKI_SUBJ_COUNTRY=US
TRUST0_GATEWAY__PKI_SUBJ_STATE=CA
TRUST0_GATEWAY__PKI_SUBJ_CITY=Nowhere0
TRUST0_GATEWAY__PKI_SUBJ_COMPANY=Example0
TRUST0_GATEWAY__PKI_SUBJ_DEPT=IT0
TRUST0_GATEWAY__PKI_SUBJ_COMMONNAME=${TRUST0_GATEWAY__PKI_NAME}
TRUST0_GATEWAY__PKI_HOST_DNS1=${TRUST0_GATEWAY__PKI_NAME}
TRUST0_GATEWAY__PKI_HOST_DNS2=localhost
TRUST0_GATEWAY__PKI_HOST_IP1=127.0.0.1
TRUST0_GATEWAY__PKI_HOST_IP2=127.1.0.3
TRUST0_GATEWAY__PKI_CERT_FILE=${PERFTEST_BUILD_DIR}/${TRUST0_GATEWAY__PKI_NAME}.crt.pem
TRUST0_GATEWAY__PKI_CERT_CONTAINER_FILE=${CONTAINER_APP_DIR}/config/${TRUST0_GATEWAY__PKI_NAME}.crt.pem
TRUST0_GATEWAY__PKI_KEY_FILE=${PERFTEST_BUILD_DIR}/${TRUST0_GATEWAY__PKI_NAME}.key.pem
TRUST0_GATEWAY__PKI_KEY_CONTAINER_FILE=${CONTAINER_APP_DIR}/config/${TRUST0_GATEWAY__PKI_NAME}.key.pem
TRUST0_GATEWAY__CONFIG_FILE=${PERFTEST_BUILD_DIR}/${TRUST0_GATEWAY__PKI_NAME}.rc
TRUST0_GATEWAY__BIND_HOST=0.0.0.0
TRUST0_GATEWAY__HOST=${TRUST0_GATEWAY__PKI_NAME}
TRUST0_GATEWAY__PORT=8400

TRUST0_GATEWAY__DATASOURCE=in-memory-db
TRUST0_GATEWAY__DB_CONNECT=${DATASOURCE_INMEMDB_DB_CONNECT}
#TRUST0_GATEWAY__DATASOURCE=mysql-db
#TRUST0_GATEWAY__DB_CONNECT=${DATASOURCE_MYSQLDB_DB_CONNECT}
#TRUST0_GATEWAY__DATASOURCE=postgres-db
#TRUST0_GATEWAY__DB_CONNECT=${DATASOURCE_POSTGRESDB_DB_CONNECT}

# Params - Trust Client

TRUST0_CLIENT__PKI_NAME=t0perf-t0client1
TRUST0_CLIENT__PKI_VALID_NOT_AFTER=2100-01-01T00:00:00Z
TRUST0_CLIENT__PKI_SERIAL_NUM=03e8
TRUST0_CLIENT__PKI_SUBJ_COUNTRY=US
TRUST0_CLIENT__PKI_SUBJ_STATE=CA
TRUST0_CLIENT__PKI_SUBJ_CITY=Nowhere1
TRUST0_CLIENT__PKI_SUBJ_COMPANY=Example1
TRUST0_CLIENT__PKI_SUBJ_DEPT=IT1
TRUST0_CLIENT__PKI_SUBJ_COMMONNAME=${TRUST0_CLIENT__PKI_NAME}
TRUST0_CLIENT__PKI_SUBJ_USERID=100
TRUST0_CLIENT__PKI_SUBJ_PLATFORM=Linux
TRUST0_CLIENT__PKI_EMAIL=support@example-client.local
TRUST0_CLIENT__PKI_CERT_FILE=${PERFTEST_BUILD_DIR}/${TRUST0_CLIENT__PKI_NAME}.crt.pem
TRUST0_CLIENT__PKI_CERT_CONTAINER_FILE=${CONTAINER_APP_DIR}/config/${TRUST0_CLIENT__PKI_NAME}.crt.pem
TRUST0_CLIENT__PKI_KEY_FILE=${PERFTEST_BUILD_DIR}/${TRUST0_CLIENT__PKI_NAME}.key.pem
TRUST0_CLIENT__PKI_KEY_CONTAINER_FILE=${CONTAINER_APP_DIR}/config/${TRUST0_CLIENT__PKI_NAME}.key.pem
TRUST0_CLIENT__CONFIG_FILE=${PERFTEST_BUILD_DIR}/${TRUST0_CLIENT__PKI_NAME}.rc
TRUST0_CLIENT__BIND_HOST=0.0.0.0
TRUST0_CLIENT__HOST=${TRUST0_CLIENT__PKI_NAME}

# Params - Key Algorithm

TRUST0_KEYALG_TYPE=ecdsa-p256
#TRUST0_KEYALG_TYPE=ecdsa-p384
#TRUST0_KEYALG_TYPE=ed25519

# Targets

.PHONY: default clean-all trust0-tools-image root-ca-pki generate-root-ca-pki-resources gateway-server-pki generate-gateway-pki-resources client-pki generate-client-pki-resources trust0-gateway-image trust0-client-image run-performance-test

default:

clean-all:
	@rm -fr ${PERFTEST_BUILD_DIR}

# Targets - PKI Provider

TRUST0_PKI_MANAGER__DOCKER_CMD=${DOCKER_CMD} run -u ${UID}:${GID} --rm -v ${PERFTEST_BUILD_DIR}:${PERFTEST_BUILD_DIR} trust0-tools:latest /app/trust0-pki-manager

# Targets - Tools

trust0-tools-image:
	@echo "Creating tools image"
	${DOCKER_COMPOSE_CMD} -f ${PROJECT_RESOURCES_DIR}/docker/docker-compose-build.yml build trust0-tools

# Targets - ROOT CA

generate-root-ca-pki-resources:
	@echo "Creating root CA PKI resources"
	${TRUST0_PKI_MANAGER__DOCKER_CMD} root-ca-pki-creator --cert-file ${ROOT_CA__PKI_CERT_FILE} --key-file ${ROOT_CA__PKI_KEY_FILE} --key-algorithm ${TRUST0_KEYALG_TYPE} --validity-not-after ${ROOT_CA__PKI_VALID_NOT_AFTER} --subject-common-name ${ROOT_CA__PKI_SUBJ_COMMONNAME} --subject-organization ${ROOT_CA__PKI_SUBJ_COMPANY} --subject-country ${ROOT_CA__PKI_SUBJ_COUNTRY}
	@echo ""

root-ca-pki: generate-root-ca-pki-resources

# Targets - Trust Gateway

.ONESHELL:
${TRUST0_GATEWAY__CONFIG_FILE}:
	@echo "Creating $@"
	@cat <<- EOF > $@
		HOST=${TRUST0_GATEWAY__BIND_HOST}
		PORT=${TRUST0_GATEWAY__PORT}
		CERT_FILE=${TRUST0_GATEWAY__PKI_CERT_CONTAINER_FILE}
		KEY_FILE=${TRUST0_GATEWAY__PKI_KEY_CONTAINER_FILE}
		GATEWAY_SERVICE_HOST=${TRUST0_GATEWAY__HOST}
		GATEWAY_SERVICE_REPLY_HOST=${TRUST0_GATEWAY__HOST}
		DATASOURCE=in-memory-db
		DB_CONNECT=/app/config
		CA_ENABLED=false
		CA_ROOT_CERT_FILE=${ROOT_CA__PKI_CERT_CONTAINER_FILE}
		NO_MASK_ADDRESSES=true
		EOF
	@echo ""

generate-gateway-pki-resources:
	@echo "Creating gateway PKI resources"
	${TRUST0_PKI_MANAGER__DOCKER_CMD} gateway-pki-creator --cert-file ${TRUST0_GATEWAY__PKI_CERT_FILE} --key-file ${TRUST0_GATEWAY__PKI_KEY_FILE} --rootca-cert-file ${ROOT_CA__PKI_CERT_FILE} --rootca-key-file ${ROOT_CA__PKI_KEY_FILE} --key-algorithm ${TRUST0_KEYALG_TYPE} --serial-number ${TRUST0_GATEWAY__PKI_SERIAL_NUM} --validity-not-after ${TRUST0_GATEWAY__PKI_VALID_NOT_AFTER} --subject-common-name ${TRUST0_GATEWAY__PKI_SUBJ_COMMONNAME} --subject-organization ${TRUST0_GATEWAY__PKI_SUBJ_COMPANY} --subject-country ${TRUST0_GATEWAY__PKI_SUBJ_COUNTRY} --san-dns-names ${TRUST0_GATEWAY__PKI_HOST_DNS1},${TRUST0_GATEWAY__PKI_HOST_DNS2}
	@echo ""

gateway-server-pki: generate-gateway-pki-resources

trust0-gateway-image:
	@echo "Creating gateway image"
	${DOCKER_COMPOSE_CMD} -f ${PROJECT_RESOURCES_DIR}/docker/docker-compose-build.yml build trust0-gateway

# Targets - Trust Client

.ONESHELL:
${TRUST0_CLIENT__CONFIG_FILE}:
	@echo "Creating $@"
	@cat <<- EOF > $@
		HOST=${TRUST0_CLIENT__BIND_HOST}
		GATEWAY_HOST=${TRUST0_GATEWAY__HOST}
		GATEWAY_PORT=${TRUST0_GATEWAY__PORT}
		AUTH_CERT_FILE=${TRUST0_CLIENT__PKI_CERT_CONTAINER_FILE}
		AUTH_KEY_FILE=${TRUST0_CLIENT__PKI_KEY_CONTAINER_FILE}
		CA_ROOT_CERT_FILE=${ROOT_CA__PKI_CERT_CONTAINER_FILE}
		EOF
	@echo ""

generate-client-pki-resources:
	@echo "Creating client PKI resources"
	${TRUST0_PKI_MANAGER__DOCKER_CMD} client-pki-creator --cert-file ${TRUST0_CLIENT__PKI_CERT_FILE} --key-file ${TRUST0_CLIENT__PKI_KEY_FILE} --rootca-cert-file ${ROOT_CA__PKI_CERT_FILE} --rootca-key-file ${ROOT_CA__PKI_KEY_FILE} --key-algorithm ${TRUST0_KEYALG_TYPE} --serial-number ${TRUST0_CLIENT__PKI_SERIAL_NUM} --validity-not-after ${TRUST0_CLIENT__PKI_VALID_NOT_AFTER} --auth-user-id ${TRUST0_CLIENT__PKI_SUBJ_USERID} --auth-platform ${TRUST0_CLIENT__PKI_SUBJ_PLATFORM} --subject-common-name ${TRUST0_CLIENT__PKI_SUBJ_COMMONNAME} --subject-organization ${TRUST0_CLIENT__PKI_SUBJ_COMPANY} --subject-country ${TRUST0_CLIENT__PKI_SUBJ_COUNTRY}
	@echo ""

client-pki: generate-client-pki-resources

trust0-client-image:
	@echo "Creating client image"
	${DOCKER_COMPOSE_CMD} -f ${PROJECT_RESOURCES_DIR}/docker/docker-compose-build.yml build trust0-client

# Targets - Performance Testing

run-performance-test:
	${DOCKER_COMPOSE_CMD} -f ${PERFTEST_BUILD_DIR}/docker-compose.yml up
